Command Line Interface (CLI)
============================
Santiago Doblas
v0.2, 30 december 2010
:author initials: SD
:email: sdoblas@qindel.com



The Command Line Interface includes the following operations:
----
root@altar:~# qvd-admin.pl --help
Valid command expected, available subcommands:
   config del
   config get
   config set
   config ssl
   host add
   host del
   host list
   host propdel
   host propget
   host propset
   host unblock
   osi add
   osi del
   osi list
   user add
   user del
   user list
   user passwd
   user propdel
   user propget
   user propset
   vm add
   vm block
   vm del
   vm disconnect_user
   vm list
   vm propdel
   vm propget
   vm propset
   vm ssh
   vm start
   vm stop
   vm unblock
   vm vnc
----

[TIP] 
======================================================================
In case of doubt it is convenient to check the help option (--help).

Many operations admit a filter (-f option).
======================================================================

Basic Operations 
----------------

Start / stop virtual machines
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There exists many ways to start and stop virtual machines.

You can run:

----
QVD-Admin/bin/qvd-admin.pl vm stop -f "user=youruser"
QVD-Admin/bin/qvd-admin.pl vm start -f "user=youruser"
----

And also you can do it from the Web Administration Tool (have a look at the documentation).

Resolving a "blocked" state
~~~~~~~~~~~~~~~~~~~~~~~~~~~


If a VM fails HKD sets a "blocked" flag for this machine. While "blocked" flag stills active no one, except the admin, can connect to it. To set and unset the blocked state for a VM you can run:

----
QVD-Admin/bin/qvd-admin.pl vm block -f "id=yourvmid"
QVD-Admin/bin/qvd-admin.pl vm unblock -f "id=yourvmid"
----

Backup
~~~~~~

Database
^^^^^^^^

Just run a complete dump of Postgres:

----
pg_dump -U postgres postgres > yourfile.backup
----

For advanced operations, check  http://www.postgresql.org/docs/8.1/static/backup.html

Files
^^^^^

For a complete QVD backup you must save the folders defined in params:

----
rw_storage_path (/var/lib/qvd/storage/overlays by default)
ro_storage_path (/var/lib/qvd/storage/images by default)
home_storage_path (/var/lib/qvd/storage/homes by default)
----

Restore
~~~~~~~

Revert your backup in the database:

----
psql -U postgres postgres < yourfile.backup
----

Files
^^^^^

Copy all the files back to the original place:

----
rw_storage_path (/var/lib/qvd/storage/overlays by default)
ro_storage_path (/var/lib/qvd/storage/images by default)
home_storage_path (/var/lib/qvd/storage/homes by default)
----

Database
^^^^^^^^

For advanced operations, check  http://www.postgresql.org/docs/8.1/static/backup.html

Other Operations
----------------

Configuration setup
~~~~~~~~~~~~~~~~~~~

It is possible to add more parameters to the system with the config set option:

----
qvd-admin.pl config set myproperty="this is a value"
----

It is also possible to get all the configuration:

----
qvd-admin.pl config get 
----

And deleting:

----
qvd-admin.pl config del myproperty
----

SSL
~~~

It is possible to set up an SSL connection manually via this command:

----
root@altar:~# qvd-admin.pl config ssl --help

config ssl: Sets the SSL certificate and private key
usage: config ssl key=mykey.pem cert=mycert.pem

    Sets the SSL certificate to the one read from the file mycert.pem, and the
    private key to the one read from mykey.pem.

    Example: config ssl key=certs/server-key.pem cert=certs/server-cert.pem
----

Hosts setup
~~~~~~~~~~~

It is possible to add, delete, list and manage the hosts properties. Here we include some examples:

----
qvd-admin.pl host add name=myhost address=127.0.0.1
qvd-admin.pl host del -f id=2 
qvd-admin.pl host list 
qvd-admin.pl host propdel prop1 -f id=3 
qvd-admin.pl host propget
qvd-admin.pl host propget -f id=3 
qvd-admin.pl host propset prop2="value for 2" -f id=2 
qvd-admin.pl host propset prop3="value for all"
qvd-admin.pl host unblock -f id=3
----

OSI setup
~~~~~~~~~

There are several options to manage the Operating System Images (OSI):

----
qvd-admin.pl osi add name=myOSI disk_image=/var/lib/qvd/storage/shared/qvd-guest.img use_overlay=no memory=1024 user_storage_size=2048
qvd-admin.pl osi del -f id=11 
qvd-admin.pl osi list 
----

User management
~~~~~~~~~~~~~~~

Thete are several operations to manage users; add, delete, list, change password, get, set or delete user information:

----
qvd-admin.pl user add login=peter password=donttellya 
qvd-admin.pl user del -f login=kk 
qvd-admin.pl user list
qvd-admin.pl user passwd peter  
qvd-admin.pl user propdel prop1 -f user_id=4 
qvd-admin.pl user propget -f user_id=3 
qvd-admin.pl user propset item=red -f login=peter
----

VM management
~~~~~~~~~~~~~

----
qvd-admin.pl vm add name=myhost user_id=4 osi_id=1 ip=127.0.0.2  storage=/tmp 
qvd-admin.pl vm del -f name=myVM 
qvd-admin.pl vm disconnect_user -f name=myhost
qvd-admin.pl vm list 
qvd-admin.pl vm propdel prop1 -f name="Test VM 1" 
qvd-admin.pl vm propget  
qvd-admin.pl vm propset prop2=otrovalor -f name=myhost 
qvd-admin.pl vm ssh -f name=myhost -- -l qvd 
qvd-admin.pl vm start -f id=1 
qvd-admin.pl vm stop -f name=myhost
qvd-admin.pl vm vnc -f id=2
----

