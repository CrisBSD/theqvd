#!/usr/bin/perl

use strict;
use warnings;
use 5.010;

use Fcntl qw(LOCK_EX LOCK_NB);

BEGIN { $QVD::Config::USE_DB = 0 }
use QVD::Config;
use QVD::Log;

my $path_cgroup = cfg('path.cgroup');
my $lock_file = cfg('internal.hkd.lock.path');

open my $lock, '>', $lock_file;
if (flock $lock, LOCK_EX|LOCK_NB) {
    for my $dir (<$path_cgroup/qvd-*>) {
        my ($container) = $dir =~ m|/(qvd-[^/]*$)|;
        DEBUG "reading LXC $container process IDs";
        if (open my $fh, '<', "$dir/cgroup.procs") {
            chomp (my @pids = <$fh>);
            if (@pids) {
                INFO sprintf("killing %d processes from container %s", scalar(@pids), ($1 // '<unknown>'));
                kill KILL => @pids;
            }
            else {
                DEBUG "LXC $container has no processes";
            }
        }
    }
}
else {
    DEBUG "HKD is running";
}

